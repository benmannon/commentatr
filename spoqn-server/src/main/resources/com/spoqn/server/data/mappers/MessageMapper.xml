<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spoqn.server.data.mappers.MessageMapper">

  <parameterMap id="message" type="com.spoqn.server.data.Message">
    <parameter property="id" typeHandler="com.spoqn.server.data.handlers.UUIDHandler" />
    <parameter property="text" />
    <parameter property="timestamp" typeHandler="com.spoqn.server.data.handlers.InstantHandler" />
    <parameter property="user" />
  </parameterMap>

  <resultMap id="message" type="com.spoqn.server.data.Message">
    <constructor>
      <arg column="text" javaType="String" />
      <arg column="message_id" javaType="java.util.UUID" typeHandler="com.spoqn.server.data.handlers.UUIDHandler" />
      <arg column="user_name" javaType="String" />
      <arg column="user_display" javaType="String" />
      <arg column="created" javaType="java.time.Instant" typeHandler="com.spoqn.server.data.handlers.InstantHandler" />
    </constructor>
  </resultMap>

  <sql id="selectAll">
    SELECT
      message.message_id
    , message.text
    , message.created
    , user.user_name
    , user.user_display
    FROM message
    INNER JOIN user ON message.user_name = user.user_name
  </sql>

  <select id="findOne" resultMap="message">
    <include refid="selectAll" />
    WHERE message_id = #{id}
  </select>

  <select id="findAll" resultMap="message">
    <include refid="selectAll" />
  </select>

  <insert id="create" parameterMap="message">
    INSERT message SET
      message_id = UUID()
    , text = #{text}
    , created = NOW()
    , user_name = #{user}
  </insert>
</mapper>